#!/bin/bash -e
set -x

SRC_DIR=$1 #  root folder of the workspace, /opt/git/workspace
BUILD_DIR=$2 # /mnt/deb-builds/${PACKAGE_NAME}-${VERSION}
PKG_BUILD_DIR=${BUILD_DIR} # root of the package, must have DEBIAN and app folder
PACKAGE_NAME=$3 # appName
VERSION=$4 # autogenerated timestamp
## SGK BUILD SCRIPT ARGUMENT
NODE_VER=${5:-lts}

echo "NODE VERSION ${NODE_VER}"
echo "Using package $PACKAGE_NAME and version ${VERSION}"

echo "${VERSION}" > ${BUILD_DIR}/version_num

# mkdir -p ${BUILD_DIR}/opt/local
mkdir -p ${BUILD_DIR}
mkdir -p ${BUILD_DIR}/DEBIAN
chmod -R 755 ${BUILD_DIR}

rsync -a ${SRC_DIR}/simple-express-app/src/* ${PKG_BUILD_DIR}

DEPENDENCIES="apache2, atop, sysstat, collectd"
# creating the main control file for this package
cat << EOF > ${BUILD_DIR}/DEBIAN/control
Package: $PACKAGE_NAME
Version: $VERSION
Maintainer: ITHAKA <support@ithaka.org>
Architecture: amd64
Section: main
Priority: optional
Depends: ${DEPENDENCIES}
Description: JSTOR Labs Express App
EOF


# create the pre-install script for this package
cat << EOPRE > ${BUILD_DIR}/DEBIAN/preinst
#!/usr/bin/env bash
set -x
echo "Install dependencies for a NODE app" > /tmp/pre-install-${PACKAGE_NAME}.log
echo "SRC_DIR=${SRC_DIR} BUILD_DIR=${BUILD_DIR}" >> /tmp/pre-install-${PACKAGE_NAME}.log
echo 'export SGK_APACHE_TIMEOUT=30' | tee -a /etc/profile.d/sagoku.sh
exit 0;

EOPRE

# creating the post-install script for this package
cat << EOPOST > ${BUILD_DIR}/DEBIAN/postinst
#!/usr/bin/env bash
set -x
echo "Can do some post-install actions by this script" > /tmp/post-install-${PACKAGE_NAME}.log
echo "SRC_DIR=${SRC_DIR} BUILD_DIR=${BUILD_DIR}" >> /tmp/post-install-${PACKAGE_NAME}.log

# obtain dependencies and get lts version of node
cd /opt/express/
npm install n -g
n ${NODE_VER}
n use ${NODE_VER}
npm install
npm install forever -g

# configure the AMI built-in apache2
a2ensite node-express.conf
a2dissite 000-default.conf
service apache2 restart

# wrap node app in forever and log output to bittybuffer->kafka
NODE_ENV=$SGK_ENVIRONMENT forever start -f /opt/express/app/www | /usr/local/bin/bittybuffer -t ${PACKAGE_NAME} -c ${PACKAGE_NAME}

EOPOST

# make inst scripts executable
chmod 755 ${BUILD_DIR}/DEBIAN/*inst

# build the package
ln -s $SRC_DIR/$PACKAGE_NAME $SRC_DIR/$3
dpkg-deb --build ${BUILD_DIR}
