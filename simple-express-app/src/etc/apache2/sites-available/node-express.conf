# NODE express


Listen 80
Listen 8080
Listen 443
Listen 8443

ExtendedStatus On

ServerName express-node
KeepAliveTimeout 61

## env vars
PassEnv SGK_APP
PassEnv SGK_APP_TYPE
PassEnv SGK_BASE_DOMAIN
PassEnv SGK_ENVIRONMENT
PassEnv SGK_DEPLOY_ID

TimeOut ${SGK_APACHE_TIMEOUT}

<Location /server-status>
    SetHandler server-status
    Require local
</Location>

<Location /server-info>
    SetHandler server-info
    Require local
</Location>

## Rewrite rules
RewriteEngine On
RewriteOptions InheritBefore

RewriteCond %{SERVER_PORT} !^8080$
RewriteCond %{REQUEST_URI} ^/watchable(.*)$ [NC,OR]
RewriteCond %{REQUEST_URI} ^/local(.*)$ [NC]
RewriteRule ^(.*)$ / [F,L]

RewriteCond %{REMOTE_ADDR} !^127\.0\.0\.1
RewriteCond %{REQUEST_URI} ^/local/(.*)$ [NC,OR]
RewriteCond %{REQUEST_URI} ^/_default/v1/up [NC,OR]
RewriteCond %{REQUEST_URI} ^/_default/v1/down [NC]
RewriteRule ^(.*)$ / [F,L]

RewriteRule ^/_logbuffer/kafka-producer$ http://localhost:${LOGBUFFER_REST_AGENT_PORT}/manage/metrics [P]
RewriteRule ^/_logbuffer/kafka-producer/(.+)$ http://localhost:${LOGBUFFER_REST_AGENT_PORT}/manage/metrics [P]
RewriteRule ^/_logbuffer/metrics$ http://localhost:${LOGBUFFER_REST_AGENT_PORT}/manage/metrics [P]
RewriteRule ^/watchable$ http://localhost:8888/watchable [P]
RewriteRule ^/watchable/(.*)$ http://localhost:8888/watchable/$1 [P]
RewriteRule ^/local/(.+)$ http://localhost:8888/local/$1 [P]

# don't proxy these
ProxyPass /server-status !
ProxyPass /server-info !

#proxy eureka-sidecar requests
ProxyPass /_default  http://localhost:8888 connectiontimeout=1
ProxyPassReverse /_default  http://localhost:8888

ProxyPass / http://localhost:3000/ connectiontimeout=3
ProxyPassReverse / http://localhost:3000/

<VirtualHost *:443>
    RewriteOptions Inherit
    SSLEngine on
    SSLCertificateFile    /etc/ssl/certs/seq-elb-ssl-server-cert.pem
    SSLCertificateKeyFile /etc/ssl/private/seq-elb-ssl-server-key.pem
    BrowserMatch "MSIE [2-6]" \
      nokeepalive ssl-unclean-shutdown \
      downgrade-1.0 force-response-1.0
    # MSIE 7 and newer should be able to use keepalive
    BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown
</VirtualHost>

<VirtualHost *:8443>
    RewriteOptions Inherit
    SSLEngine on
    SSLCertificateFile    /etc/ssl/certs/seq-elb-ssl-server-cert.pem
    SSLCertificateKeyFile /etc/ssl/private/seq-elb-ssl-server-key.pem
    SSLVerifyClient require
    SSLVerifyDepth 1
    SSLCACertificateFile /etc/ssl/certs/seq-elb-ssl-ca-cert.pem
    BrowserMatch "MSIE [2-6]" \
      nokeepalive ssl-unclean-shutdown \
      downgrade-1.0 force-response-1.0
    # MSIE 7 and newer should be able to use keepalive
    BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown
</VirtualHost>
